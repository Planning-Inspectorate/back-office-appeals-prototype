<!-- Dashed box upload area -->
    <div class="moj-multi-file-upload__upload"
      style="border: 2px dashed #b1b4b6;padding-left: 16px; padding-top: 60px; padding-bottom: 60px; align-items: center; background-color: #ffffff; margin-bottom: 30px; display: flex;">
      <div class="govuk-form-group" style="margin-bottom: 0; display: flex; align-items: center;">
        <label class="govuk-button govuk-button--secondary" for="documents" style="margin-bottom: 0; cursor: pointer;">
          Choose files
        </label>
        <p class="govuk-body" style="margin: 0; margin-left: 10px;">or drop files</p>
        <input
          class="govuk-file-upload moj-multi-file-upload__input"
          id="documents"
          name="documents"
          type="file"
          multiple
          style="position: absolute; left: -9999px;">
      </div>
    </div>
    <!-- End dashed box upload area -->

    <div class="govuk-form-group" id="filesTableGroup">
      <p class="govuk-error-message" id="filesTableError" style="display: none;">
        <span class="govuk-visually-hidden">Error:</span> Wait for all files to finish uploading
      </p>
      <table class="govuk-table" id="filesTable">
        <colgroup>
          <col style="width: 30%;">
          <col style="width: 45%;">
          <col style="width: 5%;">
        </colgroup>

        <tbody class="govuk-table__body">
        </tbody>
      </table>
    </div>

  </div>
</div>

<script>
  const fileInput = document.getElementById('documents');
  const uploadArea = document.querySelector('.moj-multi-file-upload__upload');
  const tableBody = document.querySelector('#filesTable tbody');
  const filesTableGroup = document.getElementById('filesTableGroup');
  const filesTableError = document.getElementById('filesTableError');
  const form = uploadArea.closest('form') || document.querySelector('form');
  const uploadedFiles = []; // Track successfully uploaded files with their metadata

  // Helper function to show error
  function showUploadingError() {
    // Remove any existing error summary
    const existingError = document.querySelector('.govuk-error-summary');
    if (existingError) {
      return; // Error already showing
    }

    // Create error summary matching GOV.UK styling
    const errorSummary = document.createElement('div');
    errorSummary.className = 'govuk-error-summary';
    errorSummary.setAttribute('data-module', 'govuk-error-summary');
    errorSummary.setAttribute('role', 'alert');
    errorSummary.setAttribute('aria-labelledby', 'error-summary-title');
    errorSummary.style.cssText = 'border: 5px solid #d4351c; padding: 20px; margin-bottom: 20px; background-color: #f8f8f8;';
    
    errorSummary.innerHTML = `
      <h2 class="govuk-error-summary__title" id="error-summary-title" style="color: #d4351c; margin: 0 0 15px 0; font-size: 19px; font-weight: bold;">
        There is a problem
      </h2>
      <div class="govuk-error-summary__body">
        <ul class="govuk-list govuk-error-summary__list" style="margin: 0; padding-left: 20px;">
          <li><a href="#filesTable" style="color: #d4351c; text-decoration: underline;">Wait for all files to finish uploading</a></li>
        </ul>
      </div>
    `;
    
    // Insert at the top of the upload section
    const uploadSection = document.querySelector('.moj-multi-file-upload__upload');
    uploadSection.parentNode.insertBefore(errorSummary, uploadSection);
    errorSummary.scrollIntoView({ behavior: 'smooth', block: 'start' });

    if (filesTableGroup && filesTableError) {
      filesTableGroup.classList.add('govuk-form-group--error');
      filesTableError.style.display = 'block';
    }
  }

  // Helper function to hide error
  function hideUploadingError() {
    const existingError = document.querySelector('.govuk-error-summary');
    if (existingError) {
      existingError.remove();
    }

    if (filesTableGroup && filesTableError) {
      filesTableGroup.classList.remove('govuk-form-group--error');
      filesTableError.style.display = 'none';
    }
  }

  // Handle file selection
  fileInput.addEventListener('change', function (e) {
    const files = Array.from(e.target.files);
    
    if (files.length === 0) {
      return;
    }

    // Add rows for each selected file
    files.forEach((file, index) => {
      const fileId = Date.now() + '-' + Math.random().toString(36).substr(2, 9);
      
      const row = document.createElement('tr');
      row.className = 'govuk-table__row uploading-row';
      row.dataset.file = file.name;
      row.dataset.fileId = fileId;
      row.dataset.fileSize = file.size;

      row.innerHTML = `
        <td class="govuk-table__cell">
          ${file.name} (${(file.size / 1024 / 1024).toFixed(2)}MB)
        </td>
        <td class="govuk-table__cell">
          Uploading: <span class="progress-percent">0%</span>
        </td>
        <td class="govuk-table__cell">
          <a href="#" class="govuk-link">Cancel</a>
        </td>
      `;

      tableBody.appendChild(row);

      // Trigger animation for this row
      animateUpload(row, index, file);
    });

    // Clear the input so the same files can be selected again
    fileInput.value = '';
  });

  // Handle drag and drop
  uploadArea.addEventListener('dragover', function (e) {
    e.preventDefault();
    uploadArea.style.borderColor = '#0b0c0c';
    uploadArea.style.backgroundColor = '#f8f8f8';
  });

  uploadArea.addEventListener('dragleave', function (e) {
    e.preventDefault();
    uploadArea.style.borderColor = '#b1b4b6';
    uploadArea.style.backgroundColor = '#ffffff';
  });

  uploadArea.addEventListener('drop', function (e) {
    e.preventDefault();
    uploadArea.style.borderColor = '#b1b4b6';
    uploadArea.style.backgroundColor = '#ffffff';

    const files = Array.from(e.dataTransfer.files);

    if (files.length === 0) {
      return;
    }

    // Add rows for each dropped file
    files.forEach((file, index) => {
      const fileId = Date.now() + '-' + Math.random().toString(36).substr(2, 9);
      
      const row = document.createElement('tr');
      row.className = 'govuk-table__row uploading-row';
      row.dataset.file = file.name;
      row.dataset.fileId = fileId;
      row.dataset.fileSize = file.size;

      row.innerHTML = `
        <td class="govuk-table__cell">
          ${file.name} (${(file.size / 1024 / 1024).toFixed(2)}MB)
        </td>
        <td class="govuk-table__cell">
          Uploading: <span class="progress-percent">0%</span>
        </td>
        <td class="govuk-table__cell">
          <a href="#" class="govuk-link">Cancel</a>
        </td>
      `;

      tableBody.appendChild(row);

      // Trigger animation for this row
      animateUpload(row, index, file);
    });
  });

  // Function to animate upload progress
  function animateUpload(row, index, file) {
    let percent = 0;
    const progressEl = row.querySelector('.progress-percent');

    const interval = setInterval(() => {
      percent++;
      progressEl.textContent = percent + '%';

      if (percent >= 100) {
        clearInterval(interval);

        const fileName = row.dataset.file;
        const fileId = row.dataset.fileId;
        const fileSize = row.dataset.fileSize;

        // Mark file as successfully uploaded
        uploadedFiles.push({
          id: fileId,
          name: fileName,
          size: parseInt(fileSize, 10)
        });

        row.innerHTML = `
          <td class="govuk-table__cell">
            <a href="#" class="govuk-link">${fileName}</a>
          </td>
          <td class="govuk-table__cell">
            <strong class="govuk-tag govuk-tag--green">Uploaded</strong>
          </td>
          <td class="govuk-table__cell">
            <a href="#" class="govuk-link remove-link">Remove</a>
          </td>
        `;

        // If an error is showing and all uploads are done, hide it
        const uploadingRows = document.querySelectorAll('.uploading-row');
        const stillUploading = Array.from(uploadingRows).some(r => {
          const progressEl = r.querySelector('.progress-percent');
          return progressEl && parseInt(progressEl.textContent, 10) < 100;
        });

        if (!stillUploading) {
          hideUploadingError();
        }
      }
    }, 40 + index * 20);
  }

  // Handle Cancel / Remove clicks
  document.addEventListener('click', function (e) {
    const link = e.target.closest('.govuk-link');

    if (!link) return;

    const text = link.textContent.trim();

    if (text === 'Cancel' || text === 'Remove') {
      e.preventDefault();

      const row = link.closest('.govuk-table__row');

      if (row) {
        const fileId = row.dataset.fileId;
        const index = uploadedFiles.findIndex(f => f.id === fileId);
        if (index > -1) {
          uploadedFiles.splice(index, 1);
        }
        row.remove();

        // Check if all files are done uploading
        const uploadingRows = document.querySelectorAll('.uploading-row');
        const stillUploading = Array.from(uploadingRows).some(r => {
          const progressEl = r.querySelector('.progress-percent');
          return progressEl && parseInt(progressEl.textContent, 10) < 100;
        });

        if (!stillUploading) {
          hideUploadingError();
        }
      }
    }
  });

  // Handle form submission - save uploaded files
  if (form) {
    form.addEventListener('submit', function (e) {
      // Check if any files are still uploading
      const uploadingRows = document.querySelectorAll('.uploading-row');
      const uploadingCount = Array.from(uploadingRows).filter(row => {
        const progressEl = row.querySelector('.progress-percent');
        return progressEl && parseInt(progressEl.textContent, 10) < 100;
      }).length;

      if (uploadingCount > 0) {
        e.preventDefault();
        showUploadingError();
        return;
      }

      // All files done, hide error if showing
      hideUploadingError();

      // Create a hidden input with all file data as JSON
      const fileDataInput = document.createElement('input');
      fileDataInput.type = 'hidden';
      fileDataInput.name = 'fileData';
      fileDataInput.value = JSON.stringify(uploadedFiles);
      form.appendChild(fileDataInput);
      
      console.log('Submitting files:', uploadedFiles);
    });
  }
</script>

